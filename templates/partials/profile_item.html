<div class="result-item profile-item">
  {% set aggregate_content_id = insight_content_id if insight_content_id is defined else "aggregate-analysis-content-profile" %}
  {% set aggregate_payload = insight_payload if insight_payload is defined else profile %}
  <div class="result-header">
    <h3>{{ profile.modelName }} Strength Profile</h3>
    <span class="strength-badge strength-{{ profile.overallStrength|lower }}">
      {{ profile.overallStrength }}
    </span>
  </div>

  <div class="result-body">
    {% if partial and errors %}
    <div class="dashboard-card" style="border-color: var(--accent-danger); margin-bottom: 1rem;">
      <h4 style="color: var(--accent-danger); border-color: var(--accent-danger);">Partial Results</h4>
      <p style="margin-bottom: 0.5rem;">
        {{ errors|length }} capability run{% if errors|length != 1 %}s{% endif %} failed. Profile computed from successful runs.
      </p>
      <ul class="insights-list">
        {% for error in errors %}
        <li>
          <strong>{{ error.capabilityId }}</strong> ({{ error.errorType }}): {{ error.message }}
        </li>
        {% endfor %}
      </ul>
    </div>
    {% endif %}

    <div class="result-stats-compact">
      <div class="result-stats-row">
        <span class="result-stats-count">{{ "%.2f"|format(profile.overallScore) }}</span>
        <span class="result-stats-label"><strong>Overall Score</strong></span>
      </div>
      <div class="result-stats-row">
        <span class="result-stats-count">{{ profile.tests|length }}</span>
        <span class="result-stats-label"><strong>Capability Tests Run</strong></span>
      </div>
    </div>

    <div class="analysis-dashboard" style="margin-top: 1rem;">
      <div class="dashboard-col">
        <div class="dashboard-card dashboard-card-grow">
          <h4>Strongest Areas</h4>
          <ul class="insights-list">
            {% for item in profile.strongestAreas %}
            <li>
              <strong>{{ item.title }}</strong>
              ({{ "%.2f"|format(item.averageScore) }})
            </li>
            {% endfor %}
          </ul>
        </div>
      </div>

      <div class="dashboard-col">
        <div class="dashboard-card dashboard-card-grow">
          <h4>Weakest Areas</h4>
          <ul class="insights-list">
            {% for item in profile.weakestAreas %}
            <li>
              <strong>{{ item.title }}</strong>
              ({{ "%.2f"|format(item.averageScore) }})
            </li>
            {% endfor %}
          </ul>
        </div>
      </div>

      <div class="dashboard-col">
        <div class="dashboard-card dashboard-card-grow">
          <h4>Category Breakdown</h4>
          <ul class="insights-list">
            {% for item in profile.categoryBreakdown %}
            <li>
              <strong>{{ item.category }}</strong>:
              {{ "%.2f"|format(item.averageScore) }}
              ({{ item.strength }})
            </li>
            {% endfor %}
          </ul>
        </div>
      </div>
    </div>
  </div>

  <div class="result-actions">
    <button class="btn btn-primary btn-sm" onclick="document.getElementById('analysis-{{ aggregate_content_id }}').showModal()">
      Profile Insights
    </button>
  </div>

  <dialog id="analysis-{{ aggregate_content_id }}" class="analysis-modal">
    <div class="modal-header">
      <h2>Profile Insights</h2>
      <button class="btn btn-sm" onclick="document.getElementById('analysis-{{ aggregate_content_id }}').close()">Close</button>
    </div>

    <div id="{{ aggregate_content_id }}">
      <div class="empty-state">
        <p class="empty-state-text">No aggregate insight generated yet.</p>

        <div class="analysis-input-group">
          <label for="aggregate-analyst-{{ aggregate_content_id }}" class="analysis-input-label">Analyst Model</label>
          <input
            type="text"
            name="analystModel"
            id="aggregate-analyst-{{ aggregate_content_id }}"
            value="{{ config_analyst_model }}"
            placeholder="e.g. provider/model-name"
            class="analysis-input-field"
          />
        </div>

        <textarea hidden id="aggregate-payload-{{ aggregate_content_id }}" name="payload">{{ aggregate_payload | tojson }}</textarea>
        <input hidden id="aggregate-target-{{ aggregate_content_id }}" name="targetType" value="profile" />
        <input hidden id="aggregate-content-id-{{ aggregate_content_id }}" name="contentId" value="{{ aggregate_content_id }}" />

        <button
          class="btn btn-primary"
          hx-post="/api/insights"
          hx-ext="json-enc"
          hx-include="#aggregate-analyst-{{ aggregate_content_id }}, #aggregate-payload-{{ aggregate_content_id }}, #aggregate-target-{{ aggregate_content_id }}, #aggregate-content-id-{{ aggregate_content_id }}"
          hx-target="#{{ aggregate_content_id }}"
          hx-swap="innerHTML"
          hx-indicator="#loading-aggregate-{{ aggregate_content_id }}"
        >
          Generate Profile Insights
        </button>
        <div id="loading-aggregate-{{ aggregate_content_id }}" class="htmx-indicator manual-analyze-btn">Analyzing...</div>
      </div>
    </div>
  </dialog>
</div>
