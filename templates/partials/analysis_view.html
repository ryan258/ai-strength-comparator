<div class="analysis-content">
  <div class="analysis-meta">
    <div class="analysis-meta-row">
      <span>Analysis by <strong>{{ model }}</strong> {% if cached %}(Cached){% endif %}</span>

      {% if run_id %}
      <button
        class="btn btn-sm analysis-regen-btn"
        hx-post="/api/runs/{{ run_id }}/analyze?regenerate=true"
        hx-target="#analysis-content-{{ run_id }}"
        hx-indicator="#regen-loading-{{ run_id }}"
      >
        â†» Regenerate
      </button>
      {% endif %}
    </div>
    <div id="regen-loading-{{ run_id }}" class="htmx-indicator analysis-regen-loading">
      Regenerating...
    </div>
  </div>

  {% if run_data and run_data.systemPrompt %}
  <div class="system-persona-banner">
    <h3 class="system-persona-title">System Persona Active</h3>
    <div class="system-persona-body">
      {{ run_data.systemPrompt }}
    </div>
  </div>
  {% endif %}

  {% if insight.legacy_text %}
  <div class="markdown-body">{{ insight.legacy_text | markdown }}</div>
  {% else %}
  <div class="analysis-dashboard">
    <div class="dashboard-col">
      <div class="dashboard-card dashboard-card-grow">
        <h4>Executive Summary</h4>
        <p class="consistency-text">{{ insight.executive_summary }}</p>
      </div>

      <div class="dashboard-card dashboard-card-grow">
        <h4>Strength Signals</h4>
        <ul class="insights-list">
          {% for item in insight.strengths %}
          <li>{{ item }}</li>
          {% endfor %}
        </ul>
      </div>
    </div>

    <div class="dashboard-col">
      <div class="dashboard-card dashboard-card-grow">
        <h4>Weakness Signals</h4>
        <ul class="insights-list insights-list-spaced">
          {% for item in insight.weaknesses %}
          <li>{{ item }}</li>
          {% endfor %}
        </ul>
      </div>

      <div class="dashboard-card dashboard-card-grow">
        <h4>Reliability</h4>
        <ul class="insights-list consistency-list">
          {% for item in insight.reliability %}
          <li>{{ item }}</li>
          {% endfor %}
        </ul>
      </div>
    </div>

    <div class="dashboard-col">
      <div class="dashboard-card dashboard-card-grow">
        <h4>Recommendations</h4>
        <ul class="insights-list">
          {% for item in insight.recommendations %}
          <li>{{ item }}</li>
          {% endfor %}
        </ul>
      </div>
    </div>
  </div>

  {% if run_data and run_data.capabilityType == 'capability' and run_data.summary %}
  <div class="dashboard-card distribution-card">
    <h4>Capability Score Snapshot</h4>
    <div class="distribution-list">
      <div class="distribution-item">
        <div class="distribution-row">
          <span class="distribution-option-label">Average Score</span>
          <span class="distribution-option-count">{{ "%.2f"|format(run_data.summary.averageScore or 0) }}</span>
        </div>
      </div>
      <div class="distribution-item">
        <div class="distribution-row">
          <span class="distribution-option-label">Pass Rate</span>
          <span class="distribution-option-count">{{ "%.1f"|format(run_data.summary.passRate or 0) }}%</span>
        </div>
      </div>
      <div class="distribution-item">
        <div class="distribution-row">
          <span class="distribution-option-label">Iterations Passed</span>
          <span class="distribution-option-count">{{ run_data.summary.passCount or 0 }} / {{ run_data.summary.total or 0 }}</span>
        </div>
      </div>
    </div>
  </div>
  {% endif %}

  <details class="analysis-json-details">
    <summary class="analysis-json-summary">View Analysis JSON</summary>
    <div class="analysis-json-content">
      {% if insight %}
      <pre class="analysis-json-pre"><code>{{ insight | tojson(indent=2) }}</code></pre>
      {% else %}
      <p class="analysis-json-empty">No insight data available.</p>
      {% endif %}
    </div>
  </details>
  {% endif %}
</div>
